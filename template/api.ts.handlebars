import Configuration from "./configuration";
{{#if components.schemas}}
  {{#if _options.testRun }}
    const {
      {{#each components.schemas}}{{@key}}, {{/each}}
    } = require("./model");
  {{else}}
    import {
      {{#each components.schemas}}{{@key}}, {{/each}}
    } from "./model";
  {{/if}}
{{/if}}
import { request, Parameter } from "./request";
import { deserialize, serialize } from "./serializer";

// {{info.title}}
{{!-- // {{info.description}} --}}
export default class Api {
  private config: Configuration;

  constructor(config: Configuration) {
    this.config = config;
  }

  {{#each paths}}
  {{setVar "path" @key}}
  {{#each this}}
    
    {{#if summary}}// {{summary}}{{/if}}
    {{#if description}}// {{description}}{{/if}}
    {{#each _sortedParameters}}
      // @param {{name}} {{description}}
    {{/each}}
    async {{operationId}}(
      {{#each _sortedParameters}}
        {{name}}{{#if _optional}}?{{/if}}:
        {{#if ../../../_options.testRun }}
          {{#if schema.$ref}}typeof{{/if}}
          {{#ifEquals schema.type "array"}}typeof{{/ifEquals}}
          {{typeConvert schema}}
        {{else}}
          {{typeConvert schema}}
        {{/if}}
        {{#if schema.default}} = {{{quoteIfString schema.default}}}{{/if}},
      {{/each}}
    ): Promise<
      {{#if ../../_options.testRun }}
        {{#if _response.schema.$ref}}typeof{{/if}}
        {{#ifEquals _response.schema.type "array"}}typeof{{/ifEquals}}
        {{typeConvert _response.schema}}
      {{else}}
        {{#if _response.schema}}{{typeConvert _response.schema}}{{else}}null{{/if}}
      {{/if}}
    > {
      const params: Parameter[] = [
        {{#each _sortedParameters}}{{#unless _optional}}
          {
            name: "{{name}}",
            value: serialize({{name}}, "{{typeConvert schema}}"),
            type: "{{in}}"
          },
        {{/unless}}{{/each}}
      ];
      {{#each _sortedParameters}}{{#if _optional}}
      if ({{name}}) {
        params.push({
          name: "{{name}}",
          value: serialize({{name}}, "{{typeConvert schema}}"),
          type: "{{in}}"
        })
      }
      {{/if}}{{/each}}

      const response = await request(this.config, "{{@root.path}}", "{{@key}}", params);
      return deserialize(response, "{{#if _response.schema}}{{typeConvert _response.schema}}{{else}}null{{/if}}");
    };

  {{/each}}  
  {{/each}}
}

