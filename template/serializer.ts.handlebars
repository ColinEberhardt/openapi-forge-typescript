{{#if _options.testRun }}
const model = require("./model");
const PropertyMetadata = model.PropertyMetadata;
{{else}}
import * as model from "./model";
import { PropertyMetadata } from "./model";
{{/if}}

// takes a JSON response and deserializes it into the required model objects / types
export function deserialize(json: any, type: string): any {

  // handle arrays
  if (type.endsWith("[]")) {
    const arrayType = type.substring(0, type.length - 2);
    return json.map((item: any) => deserialize(item, arrayType));
  }

  // handle model objects
  if (model.models.includes(type)) {
    // get the required and optional properties
    const properties = (<any>model)[type].propertyTypes;
    const requiredProperties = properties.filter((property: {{#if _options.testRun }}typeof {{/if}}PropertyMetadata ) => property.required);
    const optionalProperties = properties.filter((property: {{#if _options.testRun }}typeof {{/if}}PropertyMetadata) => !property.required);
    const requiredPropertyValues = requiredProperties.map((property: {{#if _options.testRun }}typeof {{/if}}PropertyMetadata) => deserialize(json[property.name], property.type));

    // create the model object
    const modelObject = new (<any>model)[type](...requiredPropertyValues);
    
    // set the optional properties
    for (const property of optionalProperties) {
      if (json[property.name] !== undefined) {
        modelObject[property.name] = deserialize(json[property.name], property.type);
      }
    }
    return modelObject;
  } 

  // handle date types
  if (type === "Date") {
    return new Date(json);
  }

  // handle additional properties
  const match = type.match(/\{ \[name: string\]: (.*) \}/);
  if (match) {
    const typeName = match[1];
    const modelObject: { [name: string]: any } = {};
    for (const key in json) {
      modelObject[key] = deserialize(json[key], typeName);
    }
    return modelObject;
  }
  
  return json;
}

export function serialize(item: any, type: string): string {
  if (type.endsWith("[]")) {
    const arrayType = type.substring(0, type.length - 2);
    return item
      .map((item: any) => serialize(item, arrayType))
      .join(",");
  }
  return typeof item === "object" ? JSON.stringify(item) : item.toString();
}


